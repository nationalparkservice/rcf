---
title: "An Introduction to the Reproducible Climate Futures package"
author: "Janelle Christensen"
date: "8-20-2021"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{An Introduction to the Reproducible Climate Futures package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```
## About this tutorial

This vignette will walk through how to use the rcf package. Using the functions in this package will enable users to be make the choice to automatically select Global Circulation Models (GCMs) that are most representative of 4 climate futures (CFs) - Warm Wet, Warm Dry (or Damp), Hot Wet, and Hot Dry (or Damp)*.

It can also be used to manipulate the data to produce summaries of threshold values for 25 variables using one of three methods (quadrant, corner, or PCA) and duration (month, season, or year).

*GCMs will be labeled as "damp" rather than "dry" if the mean of future precipitation for climate futures labeled as "dry" in that location are greater than zero.

#### Expected knowledge

This package expects that you have a basic understanding of GCMs and that each one represents a plausible climate future. The GCMs in this package are based off of the downscaled climate model [MACA](http://www.climatologylab.org/maca.html) (Multivariate Adaptive Climate Analog) Version 2. Additionally, this vignette assumes you have some knowlege of packages in the `tidyverse` specifically `readr` and the `read_csv()` function, dplyr functions such as `filter()`, `mutate()` and `select()` as well as some understanding of how to use `ggplot2`.

#### Learning goals of this vignette

At the end of this tutorial, you should be able to understand:

- the workflow of the rcf package
- naming conventions of .csv files that are output from the functions
- the different ways you can choose to summarize the data (month, season, year)
- a basic understanding of the different summarization methods in this package (quadrant, corner, PCA) and how to apply them

#### Important requirements and considerations

The files in this package, especially the raw data, are large. If you are downloading data in this package using `rcf_data()`, you will need at least *500 MB* of space. If you are using data that you have downloaded from elsewhere, specifically for the `cf_pca()` function, please pay attention to detail and ensure that anywhere you need to enter variable names that they match the column names of your dataset exactly.

[Best practices](https://rstats.wtf/project-oriented-workflow.html#work-in-a-project) in R use project directories, so this vignette will walk through the steps as if this project is using a .Rproj file inside of a directory that will hold all information and resultant data for this project. This vignette will also take use of the `here()` package, rather than relative file paths.

## Package run-through 

#### Workspace setup

First, let's load some packages.

```{r setup, message=FALSE, warning=FALSE}
library(rcf)
library(dplyr)
library(readr)
library(here)
library(ggplot2)
library(ggrepel)
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
#hidden because they are only affecting the behind the scenes of the tutorial
library(kableExtra)
library(devtools)
```

Then let's set the workspace that we will be using for all outputs from this package.

```{r}
my_directory <- "~"
```

This will set your directory to wherever the .Rproj file is located. You could alternatively create a directory in your project directory for the site you are looking at to save files there.

## 1. Download the data

Next, we will download our data using the `rcf_data()` function from the `rcfdata` package, which is currently not officially a part of this package.

This function downloads all data from the [`cft`](https://www.earthdatascience.org/cft/) package for all years from 1950 - 2099 for all 40 climate models. Because of the amount of data being downloaded, this function takes about 4 hours to run.

For this function, you can choose your units to be either "imperial" (the default) or "metric." Keep in mind that if using metric, variables that are calculated later, such as the heat index, can only be calculated with Fahrenheit. Results for those variables will convert the temperature to Fahrenheit first.

```{r, eval=FALSE}
# devtools::install_github("nationalparkservice/rcfdata")
# library(rcfdata)
# raw_data <- rcf_data(SiteID = "BAND",
#                      latitude = 35.75758546,
#                      longitude = -106.3054344,
#                      units = "imperial")
```
```{r}
raw_data <- read_csv("https://irmadev.nps.gov/DataStore/DownloadFile/660685")
```


The output of this function is a file named "BAND.csv", which will be saved in your working directory. It includes daily values of:

```{r, echo=FALSE}

names_table <- data.frame(name = c("Minimum temperature", "Maximum temperature", "Precipitation", "Minimum relative humidity", "Maximum relative humidity", "Date", "Year"), df_name = c("tmin", "tmax", "precip", "rhmin", "rhmax", "date", "yr"))

names_table %>% 
  kable(col.names = c("Variable Name",
                      "Column Name")) %>% 
# Column names - can't change row names in kable.
  kable_styling(bootstrap_options = "striped",
                full_width = F,
                position = "center") 
# Full width (F), centered table.

```


If you choose to download the data from the [`cft`](https://www.earthdatascience.org/cft/) package or another source separately, please ensure that:

- Your data includes at least gcm, date, year, minimum temperature, maximum temperature, average temperature, and precipitation - data that downloads from the cft package will include relative humidity, but the functions will not break if your dataset doesn't include relative humidity
- Data is daily observations
- The column names of those variables match the names in the table above
- Your data has a range of at least 30 years in the past and 30 years in the future

## 2. Calculate thresholds

Now that you have your raw data, the next step in the package workflow is to calculate the threshold values for this site.

We can calculate thresholds using the `calc_thresholds()` function.


```{r}
thresholds <- calc_thresholds("BAND", data = raw_data, directory = my_directory, units = "imperial")

# let's look at the data

glimpse(thresholds)

```

As you can see, the majority of the results from this function will be `TRUE` or `FALSE` observations. This is because these are tests of whether or not a value on that day crossed over a specified threshold. `TRUE` meaning that the value is more than (or, for variables like temp_under_5_pctl, is less than) the threshold, `FALSE` meaning it is not.

The output of this function is a csv file named "BAND_thresholds.csv"

For most users of this package, there will only be one more function to run before moving on to graphing. Advanced users can continue to follow along with this vignette or choose to move onto the [PCA intro](https://github.com/Janelle88/rcf_addendum/blob/master/RCF%20instructions%20-%20pca.pdf) vignette.

## 3. Calculate Climate Futures

The `cf_quadrant()` function allows users to calculate climate futures one of two ways:

1. Quadrant method - this method assigns one of 5 climate futures to each model, depending on change in precipitation and temperature from historic values, centered around one year in the future. The final values in the dataframe are the mean of all observations from all models in the quadrant, summarized by month, season or year, depending on summarization method chosen.

2. Corner method - this method assigns one of 4 climate futures to the most extreme model in each quadrant. The final values in this dataframe are the mean of all observations in that model, summarized by month, season or year, depending on the summarization method chosen.

In total, there are 6 ways you can choose to summarize the threshold data using the `cf_quadrant()` function, but here we will use the corner method and summarize by year.


```{r}
corner_year <- cf_quadrant("BAND", data = thresholds, future_year = 2040, summarize_by = "year", method = "corner", directory = my_directory)
```

The results from this function are two csvs:

1. "BAND_year_summary_c.csv" - the name of this output will change based upon what you enter into the function. Here, this file is named "year_summary" as we chose to summarize by year, but if we had chosen to summarize by month or season, this would be reflected in the file name. The "c" at the end is because we chose the corner method, but would have been labeled "q" if we had chosen the quadrant method.
2. "BAND_future_means.csv" - this file will have calculated which quadrant each model falls in as well as the most extreme model in each quadrant, if we have chosen the corner method. This csv will have to be read back into R.

Let's look at each file.

```{r}
glimpse(corner_year)
```

Because there are 2 csvs that come out of this function, the csv for the future means must be read in manually. 

```{r}
means <- read_csv("~/BAND_future_means.csv")

glimpse(means)
```

With these two files, we can now move on to making graphs.

## 4. Graphing

Let's start with two graphs that will show us where the models fall in relation to each other based on changes in temperature and precipitation, centered around our chosen year of 2040. 

First, a graph that shows all models by color in their respective quadrants.


```{r, fig.width=15, fig.height=9, out.width="110%"}
ggplot(means, aes(x = tavg_change,
                  y = precip_change,
                  xmin = min(tavg_change) - 0.15 * min(tavg_change),
                  xmax = max(tavg_change) + 0.15 * max(tavg_change),
                  ymin = min(precip_change) - 0.15 * min(precip_change),
                  ymax = max(precip_change) + 0.15 * max(precip_change))) +
  geom_text_repel(aes(label = gcm,
                      color = cf),
                  position = position_jitter(0,.2)) + 
  geom_point(size=5,colour="black") +
  geom_point(aes(color = cf),
             size = 4) +
  labs(title = "Changes in climate means centered on 2040 by GCM", 
       x = "Change in temperature (F)", 
       y = "Change in precipitation (in)") + 
  scale_color_manual(values = c("gray", "#E10720",  "#8386CC", "darksalmon", "#12045C")) +
  scale_fill_manual(values = c("gray", "#E10720",  "#8386CC", "#darksalmon", "#12045C")) + 
  theme_minimal() +
  theme(text = element_text(size = 20))
```

Second, because we have chosen the corner method, let's make a graph that highlights the selected models.

```{r, fig.width=15, fig.height=9, out.width="110%"}
ggplot(means, aes(x = tavg_change,
                  y = precip_change,
                  xmin = min(tavg_change) - 0.15 * min(tavg_change),
                  xmax = max(tavg_change) + 0.15 * max(tavg_change),
                  ymin = min(precip_change) - 0.15 * min(precip_change),
                  ymax = max(precip_change) + 0.15 * max(precip_change))) +
  geom_text_repel(aes(label = gcm,
                      color = corner),
                  position = position_jitter(0,.2)) + 
  geom_point(aes(label = gcm,
                 color = corner),
             size = 5) +
  labs(title = "Changes in climate means centered on 2040 by GCM", 
       x = "Change in temperature (F)", 
       y = "Change in precipitation (in)") + 
  scale_color_manual(values = c("#E10720",  "#12045C", "darksalmon", "#8386CC")) +
  scale_fill_manual(values = c("#E10720",  "#12045C", "darksalmon", "#8386CC")) +
  theme_minimal() +
  theme(text = element_text(size = 20))
```

Now that we have seen where our models lie in relation to each other, let's make some plots using the threshold data.

How does the precipitation change over time in the 4 climate futures?

```{r, fig.width=15, fig.height=9, out.width="110%"}
# corner_year$time <- factor(corner_year$time, levels = c("Historical", "Future"))

ggplot(data = corner_year, aes(x = time, y = precip_yearly)) +
  geom_boxplot(aes(color = time,
                   fill = time),
               alpha = 0.2) +
  geom_jitter(aes(color = time),
              size = 2.5,
              alpha =.6) +
  facet_wrap(~corner) + #facet_grid for all next to each other
  scale_color_manual(values = c("#8386CC", "#12045C")) +
  scale_fill_manual(values = c("#8386CC", "#12045C")) +
  labs(y = "Yearly Precipitation (in)",
       title = "Yearly precipitation for individual GCMs representative of 4 climate futures") +
  theme_minimal() +
  theme(text = element_text(size = 20),
        legend.title = element_blank(),
        axis.title.x = element_blank())
```

This graph could be made for any of the variables in the output from the `cf_quadrant()` function, so let's look at a few more. 

How do number of days that exceed the historical 99th percentile of heat compare in the past and future?

```{r, fig.width=15, fig.height=9, out.width="110%"}
ggplot(data = corner_year, aes(x = time, y = temp_over_99_pctl)) +
  geom_boxplot(aes(color = time,
                   fill = time),
               alpha = 0.2) +
  geom_jitter(aes(color = time),
              size = 2.5,
              alpha =.6) +
  facet_wrap(~corner) +
  scale_color_manual(values = c("darksalmon", "#E10720")) +
  scale_fill_manual(values = c("darksalmon", "#E10720")) +
  labs(y = "Number of days per year",
       title = "Days where temperature exceeds the 99th percentile for\n individual GCMs representative of 4 climate futures") +
  theme_minimal() +
  theme(text = element_text(size = 20),
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        plot.title = element_text(hjust = 0.5))
```

What about the growing season length between models? How does that compare between the four climate futures?

```{r, fig.width=15, fig.height=9, warning=FALSE, out.width="110%"}
corner_year_future <- corner_year %>%
filter(time %in% c("Future"))

ggplot(data = corner_year_future, aes(x = time, y = grow_length)) +
  geom_boxplot(aes(color = corner,
                   fill = corner),
               alpha = 0.2) +
  geom_jitter(aes(color = corner),
              size = 2.5,
              alpha =.6) +
  facet_grid(~corner) +
  scale_color_manual(values = c("#8FD834", "#72CC50", "#019875", "#00AEAD")) +
  scale_fill_manual(values = c("#8FD834", "#72CC50", "#019875", "#00AEAD")) +
  labs(y = "Length of growing season",
       title = "Growing season length for individual GCMs representative of 4 climate futures") +
  theme_minimal() +
  theme(text = element_text(size = 20),
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        plot.title = element_text(hjust = 0.5),
        axis.text.x = element_blank())
```

What if we want to compare by season or month? We can use the `cf_quadrant()` function again, this time summarizing by either month or season.

```{r}
corner_month <- cf_quadrant("BAND", data = thresholds, future_year = 2040, summarize_by = "month", method = "corner", directory = my_directory)
```

We can then graph by month or season by climate future, or across all climate futures.

```{r, fig.width=15, fig.height=9, warning=FALSE, out.width="110%"}
corner_month_hw <- corner_month %>% 
  filter(corner %in% c("Hot Wet")) %>% 
  mutate(month = lubridate::month(month, label = TRUE)) 

ggplot(data = corner_month_hw, aes(x = month, y = precip_monthly)) +
  geom_col(aes(fill = time,
               color = time), 
           position = "dodge",
           alpha = 0.7) +
  scale_color_manual(values = c("#8386CC", "#12045C")) +
  scale_fill_manual(values = c("#8386CC", "#12045C")) +
  theme_minimal() +
  theme(text = element_text(size = 20),
        legend.title = element_blank(),
        plot.title = element_text(hjust = 0.5)) +
  labs(y = "Monthly Precipitation (in)", x = " ",
       title = "Comparison of historical and future precipitation in the 'Hot Wet' climate future")
```

#### 5. Advanced Users

For users that want to try a more advanced approach to finding climate futures, the [Introduction to using PCA for model selection](https://github.com/Janelle88/rcf_addendum/blob/master/RCF%20instructions%20-%20pca.pdf) tutorial will walk you through the process.
